<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Matthias Grenié &amp; Marten Winter" />


<title>Biodiversity Facets tutorial</title>

<script src="diversity_facets_tutorial_files/header-attrs-2.9/header-attrs.js"></script>
<script src="diversity_facets_tutorial_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="diversity_facets_tutorial_files/bootstrap-3.3.5/css/united.min.css" rel="stylesheet" />
<script src="diversity_facets_tutorial_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="diversity_facets_tutorial_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="diversity_facets_tutorial_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="diversity_facets_tutorial_files/navigation-1.1/tabsets.js"></script>
<link href="diversity_facets_tutorial_files/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="diversity_facets_tutorial_files/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div id="header">



<h1 class="title toc-ignore">Biodiversity Facets tutorial</h1>
<h4 class="author">Matthias Grenié &amp; Marten Winter</h4>
<h4 class="date">30/06/2021</h4>

</div>


<div id="setup" class="section level1">
<h1>Setup</h1>
<div id="rstudio" class="section level2">
<h2>RStudio</h2>
<p>To make sure you follow along the whole tutorial you can create a new RStudio project to put all related code and data in. Click on <code>File</code> &gt; <code>New Project...</code> &gt; <code>New Directory</code> &gt; <code>New Project</code> &gt; Give it a name like <code>diversity_facets_tutorial</code> and place it in your computer.</p>
<p>This will create a new folder with an <code>.Rproj</code> file. This will let you easily return to the project without having to manually change your working directory with <code>setwd()</code> and <code>getwd()</code>.</p>
</div>
<div id="installing-needed-packages" class="section level2">
<h2>Installing needed packages</h2>
<p>We will use some specific packages in the rest of the tutorial. To make sure you have them please run the following command:</p>
<pre class="r"><code>install.packages(
  c(&quot;fundiversity&quot;,
    &quot;ade4&quot;,
    &quot;FD&quot;,
    &quot;ape&quot;,
    &quot;picante&quot;)
)</code></pre>
</div>
</div>
<div id="context-of-the-study" class="section level1">
<h1>Context of the study</h1>
<p>We will be using the data from the following study:</p>
<blockquote>
<p>Döbert, T.F., Webber, B.L., Sugau, J.B., Dickinson, K.J.M. and Didham, R.K. (2017), Logging increases the functional and phylogenetic dispersion of understorey plant communities in tropical lowland rain forest. J Ecol, 105: 1235-1245. <a href="https://doi.org/10.1111/1365-2745.12794" class="uri">https://doi.org/10.1111/1365-2745.12794</a></p>
</blockquote>
<p>Logging is the major cause of forest degradation in the Tropics. The effect of logging on taxonomic diversity is well known but more rarely studied on other facets of biodiversity such as functional diversity and phylogenetic diversity. Functional diversity and phylogenetic diversity should better reflect the impact of logging on ecosystem. For example logging can decrease the functional “redundancy” observed in ecosystems, meaning that some functional traits could be lost.</p>
<p>The tropical lowland rain forests on the island of Borneo are floristically among the most diverse systems on the planet, yet large-scale timber extraction and conversion to commercial tree plantations continue to drive their rapid degradation and loss. As is the case for the majority of tropical forests, the effects of logging on habitat quality in these forests have rarely been assessed, despite the critical implications for biodiversity conservation. Moreover, studies investigating the effects of logging on plant community dynamics across both tropical and temperate forest ecosystems have rarely focused on the understorey, despite its crucial relevance for successional trajectories.</p>
<p>Our goal with this tutorial is to reproduce the analyses from the paper and analyze how logging impacts the different facets of the diversity of the understorey vegetation, and to reveal to what extent similar facets give similar answers. The general goal is to familiarize yourself with the data and functions needed to compute diversity indices. As well the general principles behind them.</p>
</div>
<div id="loading-the-data" class="section level1">
<h1>Loading the data</h1>
<p>Fortunately for us, the authors of the study have shared openly the data they used in their article. They are available through the Dryad platform at the following link: <a href="https://doi.org/10.5061/dryad.f77p7" class="uri">https://doi.org/10.5061/dryad.f77p7</a></p>
<blockquote>
<p>Döbert, Timm F. et al. (2018), Data from: Logging increases the functional and phylogenetic dispersion of understorey plant communities in tropical lowland rainforest, Dryad, Dataset, <a href="https://doi.org/10.5061/dryad.f77p7" class="uri">https://doi.org/10.5061/dryad.f77p7</a></p>
</blockquote>
<p>The fact that these data researchers provided the full dataset including all data and meta-data will help us reproduce the exact same analyses as well as additional analyses not in their paper.</p>
<div id="getting-the-data" class="section level2">
<h2>Getting the data</h2>
<p>To get the data you can follow the above-mentioned link <a href="https://doi.org/10.5061/dryad.f77p7" class="uri">https://doi.org/10.5061/dryad.f77p7</a> and click on the “Download Dataset” button available on the top right of the webpage. It will download a .zip file that you can unzip in the folder you created for the project. This will create a folder named <code>doi_10.5061_dryad.f77p7__v1</code> that contains all needed data files. We’ve also included a copy of the unzipped file in the <code>data</code> folder of the practical project.</p>
</div>
<div id="summarizing-the-data" class="section level2">
<h2>Summarizing the data</h2>
<p>The zip file contains 5 files (also available in the <code>data/</code> folder):</p>
<ul>
<li><code>README.txt</code> which is a text file that describes the content of the other files with great precision. It details all the columns available in the other files.</li>
<li><code>PlotData.csv</code> is a comma-separated file that describes characteristics for each of the sampled vegetation plots including logging metrics, environmental variables as well as taxonomic, functional and phylogenetic diversity indices (to which we’ll compare the indices we compute ourselves).</li>
<li><code>PlotSpeciesData.csv</code> is a comma-separated file that contains a matrix of biomass values for the plant taxa sampled across the sampled vegetation plots.</li>
<li><code>phylo_tree.nwk</code> the phylogenetic tree describing the relationships between species.</li>
<li><code>SpeciesTraitData.csv</code> contains the complete list of species sampled across all vegetation plots, with their associated traits both continuous and discrete.</li>
</ul>
<p>We will load each of the file (apart from the phylogenetic tree) in your workspace now with the <code>read.csv()</code> function:</p>
<pre class="r"><code>plot_data         = read.csv(&quot;data/doi_10.5061_dryad.f77p7__v1/PlotData.csv&quot;,
                             na.strings = c(&quot;NA&quot;, &quot;na&quot;),
                             stringsAsFactors = TRUE)
plot_species_data = read.csv(&quot;data/doi_10.5061_dryad.f77p7__v1/PlotSpeciesData.csv&quot;)
species_traits    = read.csv(&quot;data/doi_10.5061_dryad.f77p7__v1/SpeciesTraitData.csv&quot;,
                             na.strings = c(&quot;NA&quot;, &quot;na&quot;), stringsAsFactors = TRUE)</code></pre>
<p>To describe the data we will use the <code>str()</code>, <code>summary()</code>, and <code>dim()</code> functions.</p>
<pre class="r"><code>str(plot_data)
summary(plot_data)

str(plot_species_data[, 1:5])
summary(head(plot_species_data)[,1:5])
dim(plot_species_data)

# Transform one column for further analyzed
species_traits$seed = ordered(species_traits$seed)
str(species_traits)
summary(species_traits)</code></pre>
<p><strong>Questions for you:</strong></p>
<ul>
<li><strong>Q1</strong>: How many plots were sampled?</li>
<li><strong>Q2</strong>: How many species are there in the dataset?</li>
<li><strong>Q3</strong>: How many traits are available?</li>
<li><strong>Q4</strong>: How many of them are continuous? How many of them are discrete?</li>
<li><strong>Q5</strong>: What is the most numerous family among all observed species?</li>
<li><strong>Q6</strong>: What is the most numerous genus?</li>
</ul>
</div>
<div id="description-of-the-environment-variables" class="section level2">
<h2>Description of the environment variables</h2>
<p>Forest loss proportion is one of the main driver variable. The data has been acquired across different block with different proportion of logging and compared to unlogged forest.</p>
<pre class="r"><code>boxplot(forestloss17 ~ block, data = plot_data,
        xlab = &quot;Block of plot&quot;, ylab = &quot;Forest loss (%)&quot;,
        main = &quot;Forest loss in funciton of block of data&quot;)</code></pre>
</div>
</div>
<div id="functional-diversity" class="section level1">
<h1>Functional diversity</h1>
<p>Now that we loaded all the datasets we can proceed to compute functional diversity per plots.</p>
<div id="computing-biomass-weighted-mean-traits-per-plot" class="section level2">
<h2>Computing Biomass-weighted mean traits per plot</h2>
<p>One first way to compute functional diversity is to compute mono-dimensional trait dimension. We can compute the average trait observed at each plot to described the effect of logging on the understorey vegetation. Because we’re interested in the average trait possessed by the community we can compute the community-weighted mean trait <span class="math inline">\(CWM_i\)</span> as follow:</p>
<p><span class="math display">\[\begin{equation}
CWM_i = \sum_{j = 1}^{S} b_{ij} \times t_j
\end{equation}\]</span></p>
<p><span class="math inline">\(CWM_i\)</span> is the community-weighted mean trait in plot <span class="math inline">\(i\)</span>, <span class="math inline">\(S\)</span> is the total number of species, <span class="math inline">\(b_{ij}\)</span> is the biomass of species <span class="math inline">\(j\)</span> in plot <span class="math inline">\(i\)</span>, and <span class="math inline">\(t_j\)</span> is the trait of species <span class="math inline">\(j\)</span>.</p>
<p>To do so we will use the function <code>functcomp()</code> in the <code>FD</code> package. But we first need to organize our data.</p>
<pre class="r"><code># Make site-species data.frame
sp_com           = plot_species_data[, -1]
rownames(sp_com) = plot_species_data$X
sp_com = as.matrix(sp_com)

# Make synthesized trait data.frame
traits = species_traits[, -c(1:5)]
rownames(traits) = species_traits$species.code</code></pre>
<p>Now that the data is organized we can compute the CWM per site for all traits:</p>
<pre class="r"><code># Get only continuous CWM
quanti_cwm = FD::functcomp(traits[, c(&quot;height&quot;, &quot;sla&quot;, &quot;wood.dens&quot;)],
                           sp_com, CWM.type = &quot;dom&quot;)
quanti_cwm$plot.code = rownames(quanti_cwm)</code></pre>
<p>The function outputs the CWM as expressed above for continuous traits. We will then merge this information with the CWM values.</p>
<pre class="r"><code># Merge environmental data with CWM
cwm_env = merge(
  quanti_cwm,
  plot_data[, c(&quot;plot.code&quot;, &quot;block&quot;, &quot;forestloss17&quot;, &quot;roaddensprim&quot;)],
  by = &quot;plot.code&quot;
)</code></pre>
<p>We can now visualize the relationship between the CWM and the environmental gradients.</p>
<pre class="r"><code>par(mfrow = c(2, 2))
plot(cwm_env$forestloss17, cwm_env$height,
     xlab = &quot;Forest loss (%)&quot;, ylab = &quot;Biomass-weighted height&quot;,
     main = &quot;CWM Height vs. forest loss&quot;)
plot(cwm_env$forestloss17, cwm_env$sla,
     xlab = &quot;Forest loss (%)&quot;, ylab = &quot;Biomass-weighted SLA&quot;,
     main = &quot;CWM SLA vs. forest loss&quot;)
plot(cwm_env$forestloss17, cwm_env$wood.dens,
     xlab = &quot;Forest loss (%)&quot;, ylab = &quot;Biomass-weighted wood density&quot;,
     main = &quot;CWM Wood density vs. forest loss&quot;)
plot(cwm_env$roaddensprim, cwm_env$height,
     xlab = &quot;Road density (km.km^-2)&quot;, ylab = &quot;Biomass-weighted height&quot;,
     main = &quot;CWM Height vs. road density&quot;)</code></pre>
<p><strong>Questions for you:</strong></p>
<ul>
<li><strong>Q7</strong>: How would you describe the relationship between the different CWMs and forest loss?</li>
<li><strong>Q8</strong>: Can you test the correlation using the function <code>cor.test()</code> and does it support your previous statements?</li>
<li><strong>Q9</strong>: How would you describe the understorey vegetation changes with increasing forest loss?</li>
</ul>
<p>Recompute the CWM by proportion of each category of each trait along the environmental gradient.</p>
<pre class="r"><code>non_quanti_cwm = FD::functcomp(traits[, -c(5:7)],
                           sp_com, CWM.type = &quot;all&quot;)
non_quanti_cwm$plot.code = rownames(non_quanti_cwm)

non_quanti_cwm = merge(
  non_quanti_cwm,
  plot_data[, c(&quot;plot.code&quot;, &quot;block&quot;, &quot;forestloss17&quot;, &quot;roaddensprim&quot;)],
  by = &quot;plot.code&quot;
)</code></pre>
<p>We used the same function as above <code>functcomp()</code> with the option <code>CWM.type = "all"</code>. The function computes the sum of biomass of each category for categorical traits.</p>
<pre class="r"><code>par(mfrow = c(1, 1))
plot(non_quanti_cwm$forestloss17, non_quanti_cwm$woody_no,
     xlab = &quot;Forest loss (%)&quot;, ylab = &quot;Sum of biomass of non-woody species&quot;,
     main = &quot;Biomass of non-woody species vs. forest loss&quot;)</code></pre>
<p><strong>Questions for you</strong></p>
<ul>
<li><strong>Q10</strong>: How does this observation compare to above description of the change of understorey vegetation along the forest loss gradient?</li>
</ul>
</div>
<div id="building-the-functional-space" class="section level2">
<h2>Building the functional space</h2>
<p>Before computing the functional diversity indices we need first to place the species on a functional space. The way to do is to visualize the species cloud onto the synthetic axes that represent their trait values. Because we cannot visualize that different traits (our vision is still limited to only 3 dimensions!) we need to use dimension reduction techniques such as <em>Principal Component Analysis</em> (PCA). Dimension reduction techniques combines the different variables to give synthetic axes accounting for the correlations between the different input variables Because we have a dataset that contain both continuous and categorical trait data, we cannot use PCA and we will have to use a slighly different statistical tool called <em>Principal Coordinates Analysis</em> (PCoA, also named Metric Dimensional Scaling) that follow similar principles.</p>
<p>To compute the PCoA we first need to compute a distance matrix that expresses the difference between each pair of species. Because we have a mixture of continuous and categorical traits, we cannot use the Euclidean distance and have to resort to use the Gower’s dissimilarity metric through the <code>daisy()</code> function with the package <code>cluster</code>.</p>
<pre class="r"><code>gower_dissim = cluster::daisy(traits)</code></pre>
<p>To perform the PCoA we will be using the <code>ade4</code> package with the function <code>dudi.pco()</code>:</p>
<pre class="r"><code>trait_pcoa = ade4::dudi.pco(ade4::quasieuclid(gower_dissim), nf = 3,
                            scannf = FALSE)
trait_pcoa</code></pre>
<p>The <code>trait_pcoa</code> object contains the coordinates of each species along the different PCoA axes (we chose 5 to have a limit). We can visualize the results with the following command:</p>
<pre class="r"><code>ade4::scatter(trait_pcoa, clab.row = 0)</code></pre>
<p>We see two well separated groups indicating strong differences along the two first axes of the PCoA. We can visualize the meaning of the groups. We can try to better understand this group by looking at the distribution of traits along these groups:</p>
<pre class="r"><code>ade4::s.class(trait_pcoa$li[,1:2], fac = traits$pgf)</code></pre>
<p><strong>Questions for you</strong></p>
<ul>
<li><strong>Q11</strong>: Using the metadata available in the <code>README.txt</code> file, what is the meaning <code>pgf</code> column means?</li>
<li><strong>Q12</strong>: How do you interpret the PCoA results given your answer to the previous question?</li>
</ul>
</div>
<div id="computing-functional-diversity-indices" class="section level2">
<h2>Computing functional diversity indices</h2>
<p>Now that we have species positioned in a multidimensional space we can actually compute distinct functional diversity indices. For that we’ll be using the <code>fundiversity</code> package that offers both flexibility and consistency to compute the indices.</p>
<p>We will first compute Functional Richness (FRic) with the <code>fd_fric()</code> function:</p>
<pre class="r"><code>site_fric = fundiversity::fd_fric(trait_pcoa$li, sp_com, stand = FALSE)</code></pre>
<p>Then we will also compute Rao’s Quadratic Entropy (Rao’s Q) and Functional Evenness (FEve):</p>
<pre class="r"><code>site_raoq = fundiversity::fd_raoq(trait_pcoa$li, sp_com)
site_feve = fundiversity::fd_feve(trait_pcoa$li, sp_com)

site_fd = merge(
  merge(site_fric, site_raoq, by = &quot;site&quot;),
  site_feve,
  by = &quot;site&quot;
)
site_fd$plot.code = site_fd$site
site_fd = site_fd[, -1]</code></pre>
<p>We can now compare the observed relationship with forest loss:</p>
<pre class="r"><code>site_env_fd = merge(site_fd,
                    plot_data[, c(&quot;plot.code&quot;, &quot;forestloss17&quot;, &quot;roaddensprim&quot;)],
                    by = &quot;plot.code&quot;)

par(mfrow = c(2, 2))
plot(site_env_fd$forestloss17, site_env_fd$FRic,
     xlab = &quot;Forest loss (%)&quot;, ylab = &quot;Functional Richness (FRic)&quot;,
     main = &quot;Functional Richness vs. forest loss&quot;)
plot(site_env_fd$forestloss17, site_env_fd$Q,
     xlab = &quot;Forest loss (%)&quot;, ylab = &quot;Rao&#39;s Quadratic Entropy&quot;,
     main = &quot;Q vs. forest loss&quot;)
plot(site_env_fd$forestloss17, site_env_fd$FEve,
     xlab = &quot;Forest loss (%)&quot;, ylab = &quot;Functional Evenness (FEve)&quot;,
     main = &quot;FEve vs. forest loss&quot;)
plot(site_env_fd$roaddensprim, site_env_fd$FRic,
     xlab = &quot;Primary Road Density (km.km^-2)&quot;, ylab = &quot;Functional Richness (FRic)&quot;,
     main = &quot;FRic vs. road density&quot;)</code></pre>
<p><strong>Questions for you</strong></p>
<ul>
<li><strong>Q13</strong>: How would you describe the relationships between functional diversity and forest loss and road density?</li>
<li><strong>Q14</strong>: Using the plot generated by the code beneath how could you describe the relationships between the three different functional diversity indices we computed?</li>
</ul>
<pre class="r"><code>panel.cor = function(x, y, digits = 2, prefix = &quot;&quot;, cex.cor, ...)
{
    usr &lt;- par(&quot;usr&quot;); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r &lt;- abs(cor(x, y, use = &quot;complete.obs&quot;))
    txt &lt;- format(c(r, 0.123456789), digits = digits)[1]
    txt &lt;- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor &lt;- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}

pairs(~FEve + Q + FRic, data = site_env_fd, lower.panel = panel.smooth,
      upper.panel = panel.cor, gap = 0, row1attop = FALSE)</code></pre>
<p>One issue we’re having with our functional diversity indices is also that some of them correlate with species richness:</p>
<pre class="r"><code>site_rich_fd = merge(
  site_fd,
  plot_data[, c(&quot;plot.code&quot;, &quot;ntaxa&quot;)],
  by = &quot;plot.code&quot;
)

pairs(ntaxa ~ FRic + FEve + Q, data = site_rich_fd, upper.panel = panel.cor)</code></pre>
<p>Because we are using indices computed with biomass values the indices should be more related to the total biomass values than species richness. Let’s get the total biomass values per site and correlate it with functional diversity indices.</p>
<pre class="r"><code>site_biomass = rowSums(sp_com)
site_biomass = stack(site_biomass)

site_biomass$plot.code = site_biomass$ind
site_biomass$tot_biomass   = site_biomass$values

site_biomass = site_biomass[, c(&quot;plot.code&quot;, &quot;tot_biomass&quot;)]

site_rich_fd = merge(
  site_rich_fd,
  site_biomass,
  by = &quot;plot.code&quot;
)

pairs(tot_biomass ~ FRic + FEve + Q, data = site_rich_fd,
      upper.panel = panel.cor)</code></pre>
<p><strong>Questions for you</strong></p>
<ul>
<li><strong>Q15</strong>: How does the relationship between indices with species richness compare with total biomass values? (You can use the function <code>cor.test()</code> if you want to test the association)</li>
</ul>
</div>
<div id="null-modeling" class="section level2">
<h2>Null modeling</h2>
<p>The principle of null modelling is to create random communities following certain rules to get an expected distribution of diversity metrics while keeping some properties of the data constant. In our case, we know that functional diversity is directly linked to the number of species, so we want to keep the species richness constant while changing the distribution of functional diversity.</p>
<p>Because the site-species matrix contains biomass values which are not discrete, the classical swapping algorithms will not work to maintain total biomass per site and species overall biomass. The solution is then to perform a null model based on trait values only. In this way it will give us a null distribution of trait values while maintaining the same richness per plot and the same relative biomass distribution.</p>
<p>To do so we’ll shuffle the trait table along species. <strong>Caution</strong>: in our case we do not want to break the links that exist between trait values, so we will be shuffling entire rows of traits and not trait individually. This would result in a different null model otherwise.</p>
<p>Because we were using the PCoA axes as our “synthetic traits” above we’ll perform the shuffling between species names on these PCoA axes.</p>
<pre class="r"><code># Set random seed so that everybody gets the same null traits
set.seed(20210705)

# Number of null simulations
# CAUTION: increasing this number may increase future computation time by a lot
n_null = 99

# Repeat the operation as many times as set aboev
null_traits = lapply(seq.int(n_null), function(x) {
  null_trait = trait_pcoa$li
  
  # Shuffle species names
  null_species = sample(rownames(trait_pcoa$li), nrow(trait_pcoa$li))
  
  # Replace species name in table
  rownames(null_trait) = null_species
  
  # Do not forget to return the modified table!
  return(null_trait)
})

str(null_traits, max.l = 0)
head(null_traits[[1]])</code></pre>
<p>We now obtain a distribution of null traits on which we still need to compute functional diversity indices. We’ll apply similar steps as above to perform the functional diversity computation. But in this case we’ll have to apply the step for each distribution of null trait.</p>
<pre class="r"><code># Beware this make take a long time
null_fd = lapply(seq(length(null_traits)), function(y) {
  
  x = null_traits[[y]]
  
  null_fric = fundiversity::fd_fric(x, sp_com, stand = FALSE)
  null_raoq = fundiversity::fd_raoq(x, sp_com)
  null_feve = fundiversity::fd_feve(x, sp_com)
  
  # Combine all null functional diversity values
  null_all = merge(
    merge(null_fric, null_raoq, by = &quot;site&quot;), null_feve, by = &quot;site&quot;
  )
  
  # Null Index to separate between all null simulations
  null_all$null_id = y
  
  return(null_all)
})

null_fd_all = do.call(rbind.data.frame, null_fd)
head(null_fd_all)</code></pre>
<p>We now observe a list of null functional diversity metrics for each site. Because computing functional diversity on null traits is computationally intensive, running more simulations can take a long time. We’ve included a version of the null functional diversity values with 999 simulations in the <code>data/</code> folder. We’re now going to use this precomputed version to get a better approximation of the expected distribution under the null hypothesis.</p>
<pre class="r"><code>null_fd_999 = readRDS(&quot;data/null_fd_999.Rds&quot;)

head(null_fd_999)</code></pre>
<p>With this null distribution we can now compare the observed values of functional diversity with the null ones. Let’s for example focus on the site <code>"a100f177r"</code>:</p>
<pre class="r"><code># The observed value of FRic for the site
subset(site_fd, plot.code == &quot;a100f177r&quot;)$FRic

# The null distribution of FRic for the same site
summary(subset(null_fd_999, site == &quot;a100f177r&quot;)$FRic)</code></pre>
<p>We can visualize this comparison with an histogram:</p>
<pre class="r"><code>par(mfrow = c(1, 1))
# Visualize histogram of null values
hist(subset(null_fd_999, site == &quot;a100f177r&quot;)$FRic,
     breaks = 20,
     xlab = &quot;null Functional Richness&quot;,
     ylab = &quot;Frequency&quot;,
     main = &quot;FRic comparison for site &#39;a100f177r&#39;&quot;)
abline(v = subset(site_fd, plot.code == &quot;a100f177r&quot;)$FRic,
       col = &quot;darkred&quot;, lwd = 2)</code></pre>
<p><strong>Question for you</strong></p>
<ul>
<li><strong>Q16</strong>: How would describe verbally the position of the observed value of FRic for site “a100f177r” compared to the null distribution?</li>
</ul>
<p>To get a proper estimate of the relartive position of the observed value compared to the null distribution we have to build the Empirical Cumulative Distribution Function (ECDF) that will give us the exact quantile of the observed value. We will do so with the <code>ecdf()</code> function:</p>
<pre class="r"><code># Build the ECDF
one_null_fric_ecdf = ecdf(subset(null_fd_999, site == &quot;a100f177r&quot;)$FRic)

# Then actually use it
obs_fric = subset(site_fd, plot.code == &quot;a100f177r&quot;)$FRic

one_null_fric_ecdf(obs_fric)</code></pre>
<p><strong>Question for you</strong></p>
<ul>
<li><strong>Q17</strong>: What the quantile of the observed FRic value in the end?</li>
</ul>
<p>This gives us an empirical comparison of the observed value with the null distribution. However, in macro-ecology we prefer to even standardize further through the use of Standardized Effect Sizes (SES). As it is done in the article we are using for our analyses. These are simpler to compute than ECDF and simplify the interpretation. SESs are computed in the following way:</p>
<p><span class="math display">\[
SES_i = \frac{\overline{y_{\text{null}, i}} - y_{\text{obs}, i}}{\text{SD}_{\text{null}, i}}
\]</span> with <span class="math inline">\(SES_i\)</span> the standardized effect size of the index at site <span class="math inline">\(i\)</span>, <span class="math inline">\(\overline{y_{\text{null}, i}\)</span> the average observed value along the null distribution of the index at site <span class="math inline">\(i\)</span>, <span class="math inline">\(y_{\text{obs}, i}\)</span>, and <span class="math inline">\(\text{SD}_{\text{null}, i}\)</span> the standard deviation of the null distribution of the index at site <span class="math inline">\(i\)</span>. This index is negative when the observation is smaller than the average of the null distribution, and positive otherwise. In the literature an SES value under -2 or above 2 is generally considered as significant.</p>
<p><strong>However</strong>, note that there are controversies in the literature about the use of SESs compared to the use of the ECDF because we’re only leveraging on the use of the mean and standard deviation of the null distribution instead of using the entirety of the distribution.</p>
<p>Now we need for each index and each site to compute the average and standard deviation of the null distribution.</p>
</div>
<div id="mapping-functional-diversity" class="section level2">
<h2>Mapping functional diversity</h2>
</div>
</div>
<div id="phylogenetic-diversity" class="section level1">
<h1>Phylogenetic diversity</h1>
<div id="getting-the-phylogenetic-tree" class="section level2">
<h2>Getting the phylogenetic tree</h2>
</div>
<div id="computing-phylogenetic-diversity-indices" class="section level2">
<h2>Computing phylogenetic diversity indices</h2>
</div>
<div id="mapping-phylogenetic-diversity" class="section level2">
<h2>Mapping phylogenetic diversity</h2>
</div>
</div>
<div id="comparing-facets" class="section level1">
<h1>Comparing facets</h1>
</div>
<div id="modelling-the-effect-of-logging-and-other-variables" class="section level1">
<h1>Modelling the effect of logging and other variables</h1>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
